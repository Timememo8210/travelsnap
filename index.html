<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TravelSnap ğŸŒ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;
  --accent:#6366f1;--accent2:#818cf8;--accent-glow:rgba(99,102,241,.15);
  --text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --border:#1e1e2e;--grad1:#6366f1;--grad2:#a855f7;--grad3:#ec4899;
  --radius:16px;--transition:.3s cubic-bezier(.4,0,.2,1);
  --danger:#ef4444;
}
html{font-size:16px}
body{font-family:'Inter','Noto Sans SC',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow:hidden;height:100vh}
::selection{background:var(--accent);color:#fff}

/* Language Toggle */
.lang-toggle{
  position:fixed;top:14px;right:20px;z-index:1100;display:flex;gap:4px;
  background:rgba(26,26,38,.8);border:1px solid var(--border);border-radius:24px;padding:3px;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
}
.lang-btn{padding:5px 12px;border:none;border-radius:20px;cursor:pointer;font-size:.75rem;font-weight:600;background:transparent;color:var(--text3);transition:var(--transition)}
.lang-btn.active{background:var(--accent);color:#fff}

/* Header */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 24px;background:rgba(10,10,15,.85);
  border-bottom:1px solid var(--border);position:relative;z-index:1000;
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
}
.logo{font-size:1.2rem;font-weight:700;background:linear-gradient(135deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-stats{display:flex;gap:28px}
.header-stats .stat-item{text-align:center}
.header-stats .stat-num{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:block;line-height:1}
.header-stats .stat-label{font-size:.65rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.header-actions{display:flex;gap:8px}

/* Buttons */
.btn{
  padding:8px 18px;border:none;border-radius:12px;font-size:.8rem;font-weight:600;
  cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:6px;text-decoration:none;
}
.btn-primary{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff;box-shadow:0 4px 20px rgba(99,102,241,.25)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(99,102,241,.35)}
.btn-outline{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-outline:hover{border-color:var(--accent);color:var(--text);background:var(--accent-glow)}

/* Map */
#map{height:calc(100vh - 56px);width:100%}
.leaflet-container{background:var(--bg)}

/* Custom markers */
.custom-marker{
  width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:17px;
  background:var(--surface2);border:2px solid var(--accent);
  box-shadow:0 0 16px rgba(99,102,241,.3);transition:transform .2s;
}
.custom-marker:hover{transform:scale(1.2)}

/* Popup override */
.leaflet-popup-content-wrapper{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);box-shadow:0 8px 32px rgba(0,0,0,.4)}
.leaflet-popup-tip{background:var(--surface);border:1px solid var(--border)}
.trip-popup h3{font-size:.95rem;font-weight:700;margin-bottom:4px}
.trip-popup .date{font-size:.75rem;color:var(--text3);margin-bottom:6px}
.trip-popup .note{font-size:.8rem;color:var(--text2);margin-bottom:8px;line-height:1.5}
.trip-popup .photos{display:flex;gap:6px;margin-bottom:8px}
.trip-popup .photos img{width:100px;height:70px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid var(--border)}
.trip-popup .actions{display:flex;gap:6px}
.popup-btn{padding:5px 12px;border:none;border-radius:8px;font-size:.7rem;cursor:pointer;font-weight:600;transition:var(--transition)}
.popup-btn-edit{background:var(--accent-glow);color:var(--accent2)}
.popup-btn-edit:hover{background:rgba(99,102,241,.25)}
.popup-btn-del{background:rgba(239,68,68,.1);color:#f87171}
.popup-btn-del:hover{background:rgba(239,68,68,.2)}

/* Filter bar */
.filter-bar{
  position:absolute;top:68px;left:50%;transform:translateX(-50%);z-index:1000;
  display:flex;gap:6px;background:rgba(18,18,26,.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  padding:6px 14px;border-radius:24px;border:1px solid var(--border);box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.filter-chip{
  padding:5px 14px;border-radius:20px;font-size:.75rem;font-weight:600;
  border:1px solid var(--border);background:transparent;color:var(--text3);cursor:pointer;transition:var(--transition);
}
.filter-chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.filter-chip:hover{border-color:var(--accent);color:var(--accent2)}

/* Country legend */
.country-legend{
  position:absolute;bottom:30px;left:16px;z-index:1000;
  background:rgba(18,18,26,.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;
  box-shadow:0 4px 20px rgba(0,0,0,.3);max-width:200px;
}
.country-legend h4{font-size:.75rem;color:var(--accent2);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:600}
.legend-item{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:.8rem;color:var(--text2)}
.legend-color{width:14px;height:14px;border-radius:4px;flex-shrink:0}

/* Side Panel */
.panel-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:2000;display:none}
.panel-overlay.active{display:block}
.side-panel{
  position:fixed;top:0;right:-440px;width:420px;height:100vh;
  background:rgba(18,18,26,.95);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-left:1px solid var(--border);z-index:2001;transition:right .3s ease;
  overflow-y:auto;padding:28px;
}
.side-panel.active{right:0}
.panel-title{font-size:1.1rem;font-weight:700;margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}
.panel-close{background:none;border:none;color:var(--text3);font-size:1.3rem;cursor:pointer;transition:var(--transition)}
.panel-close:hover{color:var(--text)}

/* Form */
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:.75rem;color:var(--text3);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.form-input{
  width:100%;padding:11px 14px;background:var(--bg);border:1px solid var(--border);
  border-radius:12px;color:var(--text);font-size:.9rem;outline:none;transition:var(--transition);
  font-family:'Inter','Noto Sans SC',sans-serif;
}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(99,102,241,.15)}
textarea.form-input{resize:vertical;min-height:80px}
.form-row{display:flex;gap:12px}
.form-row .form-group{flex:1}

/* Photo upload */
.photo-upload{
  border:2px dashed var(--border);border-radius:12px;padding:20px;
  text-align:center;cursor:pointer;transition:var(--transition);
}
.photo-upload:hover{border-color:var(--accent)}
.photo-upload-icon{font-size:1.8rem;margin-bottom:6px}
.photo-upload-text{font-size:.8rem;color:var(--text3)}
.photo-preview{display:flex;gap:8px;margin-top:10px}
.photo-preview-item{position:relative}
.photo-preview-item img{width:80px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
.photo-preview-item .remove{
  position:absolute;top:-6px;right:-6px;width:20px;height:20px;
  background:var(--danger);color:#fff;border:none;border-radius:50%;font-size:.65rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}

/* List items */
.list-item{
  display:flex;align-items:center;gap:14px;padding:14px;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  margin-bottom:10px;cursor:pointer;transition:var(--transition);
}
.list-item:hover{border-color:var(--accent);transform:translateX(4px)}
.list-item-icon{font-size:1.4rem}
.list-item-info{flex:1}
.list-item-name{font-size:.9rem;font-weight:600}
.list-item-date{font-size:.75rem;color:var(--text3)}

/* Export overlay */
.export-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:3000;display:none;align-items:center;justify-content:center}
.export-overlay.active{display:flex}
.export-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:28px;max-width:500px;width:90%;text-align:center;
  box-shadow:0 8px 40px rgba(0,0,0,.5);
}
.export-card h3{margin-bottom:8px;font-size:1.1rem}
.export-preview{margin:16px 0;border-radius:12px;overflow:hidden}
.export-preview img{width:100%;border-radius:12px}
.export-actions{display:flex;gap:10px;justify-content:center}

/* Lightbox */
.lightbox{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.92);z-index:4000;display:none;align-items:center;justify-content:center;cursor:pointer}
.lightbox.active{display:flex}
.lightbox img{max-width:90%;max-height:90%;border-radius:12px}

/* Mobile bottom nav */
.mobile-nav{
  display:none;position:fixed;bottom:0;left:0;right:0;z-index:1000;
  background:rgba(10,10,15,.9);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  padding:8px 12px calc(8px + env(safe-area-inset-bottom,0px)) 12px;
}
.mobile-nav-inner{display:flex;gap:8px}
.mobile-nav .btn{flex:1;justify-content:center;min-height:46px;font-size:.85rem;border-radius:12px}

/* Mobile stats */
.mobile-stats{
  display:none;position:absolute;top:68px;right:12px;z-index:1000;
  background:rgba(18,18,26,.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;gap:16px;
}
.mobile-stats .stat-item{text-align:center}
.mobile-stats .stat-num{font-size:1.6rem;font-weight:800;background:linear-gradient(135deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.mobile-stats .stat-label{font-size:.6rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:2px}

@media(max-width:768px){
  .header-stats{display:none}
  .header-actions .btn{display:none}
  .lang-toggle{top:14px;right:70px}
  .mobile-nav{display:block}
  .mobile-stats{display:flex}
  .side-panel{width:100%;right:-100%;padding:20px;padding-bottom:calc(80px + env(safe-area-inset-bottom,0px))}
  .filter-bar{width:92%;left:4%;transform:none;top:62px}
  .country-legend{bottom:80px;max-width:160px;padding:10px 12px}
  #map{height:calc(100vh - 52px - 62px)}
  .form-input{padding:12px 14px;font-size:.95rem}
  .btn{min-height:46px}
}
</style>
</head>
<body>

<!-- Language Toggle -->
<div class="lang-toggle">
  <button class="lang-btn" id="lang-zh" onclick="setLang('zh')">ä¸­æ–‡</button>
  <button class="lang-btn" id="lang-en" onclick="setLang('en')">EN</button>
</div>

<!-- Header -->
<div class="header">
  <div class="logo">TravelSnap</div>
  <div class="header-stats">
    <div class="stat-item"><span class="stat-num" id="stat-countries">0</span><span class="stat-label" data-i18n="countries">Countries</span></div>
    <div class="stat-item"><span class="stat-num" id="stat-cities">0</span><span class="stat-label" data-i18n="cities">Cities</span></div>
    <div class="stat-item"><span class="stat-num" id="stat-trips">0</span><span class="stat-label" data-i18n="trips">Trips</span></div>
  </div>
  <div class="header-actions">
    <button class="btn btn-outline" onclick="openList()" data-i18n="btnList">ğŸ“‹ List</button>
    <button class="btn btn-outline" onclick="exportImage()" data-i18n="btnExport">ğŸ“¤ Export</button>
    <button class="btn btn-primary" onclick="openAddPanel()" data-i18n="btnAdd">ï¼‹ Add Trip</button>
  </div>
</div>

<!-- Filter -->
<div class="filter-bar" id="filter-bar"></div>

<!-- Map -->
<div id="map"></div>

<!-- Mobile stats -->
<div class="mobile-stats" id="mobile-stats">
  <div class="stat-item"><div class="stat-num" id="m-stat-countries">0</div><div class="stat-label" data-i18n="countries">Countries</div></div>
  <div class="stat-item"><div class="stat-num" id="m-stat-cities">0</div><div class="stat-label" data-i18n="cities">Cities</div></div>
  <div class="stat-item"><div class="stat-num" id="m-stat-trips">0</div><div class="stat-label" data-i18n="trips">Trips</div></div>
</div>

<!-- Mobile nav -->
<div class="mobile-nav">
  <div class="mobile-nav-inner">
    <button class="btn btn-outline" onclick="openList()" data-i18n="btnList">ğŸ“‹ List</button>
    <button class="btn btn-primary" onclick="openAddPanel()" data-i18n="btnAdd">ï¼‹ Add Trip</button>
    <button class="btn btn-outline" onclick="exportImage()" data-i18n="btnExport">ğŸ“¤ Export</button>
  </div>
</div>

<!-- Legend -->
<div class="country-legend" id="country-legend" style="display:none">
  <h4 data-i18n="legendTitle">âœ¦ Visited</h4>
  <div id="legend-items"></div>
</div>

<!-- Add/Edit Panel -->
<div class="panel-overlay" id="panel-overlay" onclick="closePanel()"></div>
<div class="side-panel" id="side-panel">
  <div class="panel-title">
    <span id="panel-title-text" data-i18n="panelAdd">âœˆï¸ Add New Trip</span>
    <button class="panel-close" onclick="closePanel()">âœ•</button>
  </div>
  <form id="trip-form" onsubmit="saveTrip(event)">
    <input type="hidden" id="edit-id" value="">
    <div class="form-group">
      <label class="form-label" data-i18n="labelPlace">ğŸ“ Place *</label>
      <input type="text" class="form-input" id="inp-place" data-i18n-ph="phPlace" placeholder="e.g. Paris, Tokyo Tower" required>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" data-i18n="labelCountry">ğŸŒ Country *</label>
        <input type="text" class="form-input" id="inp-country" data-i18n-ph="phCountry" placeholder="e.g. France" required>
      </div>
      <div class="form-group">
        <label class="form-label" data-i18n="labelCity">ğŸ™ï¸ City</label>
        <input type="text" class="form-input" id="inp-city" data-i18n-ph="phCity" placeholder="e.g. Paris">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" data-i18n="labelStart">ğŸ“… Start *</label>
        <input type="date" class="form-input" id="inp-date-start" required>
      </div>
      <div class="form-group">
        <label class="form-label" data-i18n="labelEnd">ğŸ“… End</label>
        <input type="date" class="form-input" id="inp-date-end">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="labelNote">ğŸ“ Notes</label>
      <textarea class="form-input" id="inp-note" data-i18n-ph="phNote" placeholder="Your travel story..."></textarea>
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="labelPhoto">ğŸ“¸ Photos (max 2)</label>
      <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
        <div class="photo-upload-icon">ğŸ“·</div>
        <div class="photo-upload-text" data-i18n="photoUpload">Click to upload</div>
      </div>
      <input type="file" id="photo-input" accept="image/*" multiple style="display:none" onchange="handlePhotos(this)">
      <div class="photo-preview" id="photo-preview"></div>
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="labelCoord">ğŸ“Œ Coordinates (optional)</label>
      <div class="form-row">
        <input type="number" step="any" class="form-input" id="inp-lat" data-i18n-ph="phLat" placeholder="Lat">
        <input type="number" step="any" class="form-input" id="inp-lng" data-i18n-ph="phLng" placeholder="Lng">
      </div>
      <div style="font-size:.7rem;color:var(--text3);margin-top:4px" data-i18n="coordTip">ğŸ’¡ Right-click map to pick coordinates</div>
    </div>
    <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:14px;font-size:.9rem" data-i18n="btnSave">ğŸ’¾ Save Trip</button>
  </form>
</div>

<!-- List Panel -->
<div class="panel-overlay" id="list-overlay" onclick="closeList()"></div>
<div class="side-panel" id="list-panel">
  <div class="panel-title">
    <span data-i18n="myFootprints">ğŸ“‹ My Trips</span>
    <button class="panel-close" onclick="closeList()">âœ•</button>
  </div>
  <div id="trip-list"></div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src=""></div>

<!-- Export -->
<div class="export-overlay" id="export-overlay">
  <div class="export-card">
    <h3 data-i18n="exportTitle">ğŸ“¤ Export Share Image</h3>
    <p style="color:var(--text3);font-size:.8rem;margin-bottom:12px" data-i18n="exportGen">Generating...</p>
    <div class="export-preview" id="export-preview"></div>
    <div class="export-actions">
      <button class="btn btn-outline" onclick="closeExport()" data-i18n="close">Close</button>
      <button class="btn btn-primary" onclick="downloadExport()" data-i18n="download">ğŸ’¾ Download</button>
    </div>
  </div>
</div>

<script>
// ===== i18n =====
let lang = localStorage.getItem('travelsnap_lang') || 'zh';
const I18N = {
  zh: {
    countries:'ä¸ªå›½å®¶',cities:'ä¸ªåŸå¸‚',trips:'æ¬¡æ—…è¡Œ',
    btnList:'ğŸ“‹ è¶³è¿¹åˆ—è¡¨',btnExport:'ğŸ“¤ å¯¼å‡ºåˆ†äº«',btnAdd:'ï¼‹ æ·»åŠ è¶³è¿¹',
    filterAll:'å…¨éƒ¨',filterYear:'å¹´',legendTitle:'âœ¦ åˆ°è®¿å›½å®¶',
    panelAdd:'âœˆï¸ æ·»åŠ æ–°è¶³è¿¹',panelEdit:'âœï¸ ç¼–è¾‘è¶³è¿¹',
    labelPlace:'ğŸ“ åœ°ç‚¹åç§° *',labelCountry:'ğŸŒ å›½å®¶ *',labelCity:'ğŸ™ï¸ åŸå¸‚',
    labelStart:'ğŸ“… å¼€å§‹æ—¥æœŸ *',labelEnd:'ğŸ“… ç»“æŸæ—¥æœŸ',labelNote:'ğŸ“ æ—…è¡Œç¬”è®°',
    labelPhoto:'ğŸ“¸ ç…§ç‰‡ï¼ˆæœ€å¤š2å¼ ï¼‰',labelCoord:'ğŸ“Œ åæ ‡ï¼ˆå¯é€‰ï¼‰',
    phPlace:'å¦‚ï¼šå·´é»ã€ä¸œäº¬å¡”',phCountry:'å¦‚ï¼šæ³•å›½',phCity:'å¦‚ï¼šå·´é»',
    phNote:'è®°å½•æ—…è¡Œæ„Ÿå—...',phLat:'çº¬åº¦',phLng:'ç»åº¦',
    coordTip:'ğŸ’¡ å³é”®åœ°å›¾è·å–åæ ‡',photoUpload:'ç‚¹å‡»ä¸Šä¼ ',btnSave:'ğŸ’¾ ä¿å­˜',
    myFootprints:'ğŸ“‹ æˆ‘çš„è¶³è¿¹',noTrips:'è¿˜æ²¡æœ‰è¶³è¿¹ï¼Œå¼€å§‹æ·»åŠ å§ï¼',
    edit:'âœï¸ ç¼–è¾‘',delete:'ğŸ—‘ï¸ åˆ é™¤',confirmDel:'ç¡®å®šåˆ é™¤ï¼Ÿ',
    geoFail:'æ— æ³•å®šä½ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥åæ ‡',
    exportTitle:'ğŸ“¤ å¯¼å‡ºåˆ†äº«å›¾',exportGen:'æ­£åœ¨ç”Ÿæˆ...',close:'å…³é—­',download:'ğŸ’¾ ä¸‹è½½',
    noData:'è¿˜æ²¡æœ‰æ•°æ®ï¼',exportMyTrips:'ğŸŒ æˆ‘çš„æ—…è¡Œè¶³è¿¹',
  },
  en: {
    countries:'Countries',cities:'Cities',trips:'Trips',
    btnList:'ğŸ“‹ List',btnExport:'ğŸ“¤ Export',btnAdd:'ï¼‹ Add Trip',
    filterAll:'All',filterYear:'',legendTitle:'âœ¦ VISITED',
    panelAdd:'âœˆï¸ Add New Trip',panelEdit:'âœï¸ Edit Trip',
    labelPlace:'ğŸ“ Place *',labelCountry:'ğŸŒ Country *',labelCity:'ğŸ™ï¸ City',
    labelStart:'ğŸ“… Start *',labelEnd:'ğŸ“… End',labelNote:'ğŸ“ Notes',
    labelPhoto:'ğŸ“¸ Photos (max 2)',labelCoord:'ğŸ“Œ Coordinates',
    phPlace:'e.g. Paris, Tokyo Tower',phCountry:'e.g. France',phCity:'e.g. Paris',
    phNote:'Your travel story...',phLat:'Lat',phLng:'Lng',
    coordTip:'ğŸ’¡ Right-click map to pick',photoUpload:'Click to upload',btnSave:'ğŸ’¾ Save',
    myFootprints:'ğŸ“‹ My Trips',noTrips:'No trips yet!',
    edit:'âœï¸ Edit',delete:'ğŸ—‘ï¸ Delete',confirmDel:'Delete this trip?',
    geoFail:'Cannot locate. Enter coordinates manually.',
    exportTitle:'ğŸ“¤ Export Image',exportGen:'Generating...',close:'Close',download:'ğŸ’¾ Download',
    noData:'No data!',exportMyTrips:'ğŸŒ My Travel Map',
  }
};
function t(k){return I18N[lang][k]||k}
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(I18N[lang][k])el.textContent=I18N[lang][k]});
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{const k=el.getAttribute('data-i18n-ph');if(I18N[lang][k])el.placeholder=I18N[lang][k]});
  document.getElementById('lang-zh').classList.toggle('active',lang==='zh');
  document.getElementById('lang-en').classList.toggle('active',lang==='en');
}
function setLang(l){lang=l;localStorage.setItem('travelsnap_lang',lang);applyLang();setMapTiles();render()}

// ===== Country Colors (gradient-matched) =====
const COUNTRY_COLORS=['#6366f1','#a855f7','#ec4899','#f59e0b','#10b981','#06b6d4','#ef4444','#84cc16','#f97316','#8b5cf6','#14b8a6','#e11d48'];
let countryColorMap={};
function getCountryColor(c){if(!countryColorMap[c]){countryColorMap[c]=COUNTRY_COLORS[Object.keys(countryColorMap).length%COUNTRY_COLORS.length]}return countryColorMap[c]}

// ===== Data =====
let trips=JSON.parse(localStorage.getItem('travelsnap_trips')||'[]');
let uploadedPhotos=[],currentFilter='all',markers=[],countryLayers=[],geoJsonData=null;

// ===== Map =====
const map=L.map('map',{center:[30,110],zoom:3,zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);

let currentTileLayer=null;
function setMapTiles(){
  if(currentTileLayer)map.removeLayer(currentTileLayer);
  const hl=lang==='zh'?'zh-CN':'en';
  currentTileLayer=L.tileLayer(`https://mt{s}.google.com/vt/lyrs=m&hl=${hl}&x={x}&y={y}&z={z}`,{
    attribution:'Â© Google',maxZoom:20,subdomains:'0123'
  }).addTo(map);
}
setMapTiles();

map.on('contextmenu',e=>{document.getElementById('inp-lat').value=e.latlng.lat.toFixed(6);document.getElementById('inp-lng').value=e.latlng.lng.toFixed(6);openAddPanel()});

// ===== GeoJSON =====
async function loadGeoJson(){try{const r=await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');geoJsonData=await r.json()}catch(e){}}

const ZH_TO_EN={'ä¸­å›½':'China','ç¾å›½':'United States of America','æ—¥æœ¬':'Japan','éŸ©å›½':'South Korea','æ³•å›½':'France','å¾·å›½':'Germany','è‹±å›½':'United Kingdom','æ„å¤§åˆ©':'Italy','è¥¿ç­ç‰™':'Spain','æ¾³å¤§åˆ©äºš':'Australia','åŠ æ‹¿å¤§':'Canada','æ–°åŠ å¡':'Singapore','æ³°å›½':'Thailand','è¶Šå—':'Vietnam','å°åº¦':'India','å·´è¥¿':'Brazil','å¢¨è¥¿å“¥':'Mexico','åŸƒåŠ':'Egypt','åœŸè€³å…¶':'Turkey','å¸Œè…Š':'Greece','ç‘å£«':'Switzerland','è·å…°':'Netherlands','è‘¡è„ç‰™':'Portugal','ä¿„ç½—æ–¯':'Russia','é©¬æ¥è¥¿äºš':'Malaysia','å°å°¼':'Indonesia','æ–°è¥¿å…°':'New Zealand','å¥¥åœ°åˆ©':'Austria','ç‘å…¸':'Sweden','æŒªå¨':'Norway','ä¸¹éº¦':'Denmark','èŠ¬å…°':'Finland','å†°å²›':'Iceland','æ·å…‹':'Czech Republic','æ³¢å…°':'Poland','åŒˆç‰™åˆ©':'Hungary','æŸ¬åŸ”å¯¨':'Cambodia','ç¼…ç”¸':'Myanmar','è²å¾‹å®¾':'Philippines','å—é':'South Africa','é˜¿è”é…‹':'United Arab Emirates','ä»¥è‰²åˆ—':'Israel','å°æ¹¾':'Taiwan','çˆ±å°”å…°':'Ireland','æ¯”åˆ©æ—¶':'Belgium','é˜¿æ ¹å»·':'Argentina','æ™ºåˆ©':'Chile','ç§˜é²':'Peru','å“¥ä¼¦æ¯”äºš':'Colombia','å¤å·´':'Cuba','æ–¯é‡Œå…°å¡':'Sri Lanka','å°¼æ³Šå°”':'Nepal','æ‘©æ´›å“¥':'Morocco','çº¦æ—¦':'Jordan'};

async function geocode(q){try{const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);const d=await r.json();if(d.length)return{lat:+d[0].lat,lng:+d[0].lon}}catch(e){}return null}

// ===== Render =====
function render(){
  markers.forEach(m=>map.removeLayer(m));markers=[];
  countryLayers.forEach(l=>map.removeLayer(l));countryLayers=[];
  const filtered=currentFilter==='all'?trips:trips.filter(t=>t.dateStart&&t.dateStart.startsWith(currentFilter));
  const countries=new Set(filtered.map(t=>t.country));
  const cities=new Set(filtered.filter(t=>t.city).map(t=>t.city));
  ['stat-countries','m-stat-countries'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=countries.size});
  ['stat-cities','m-stat-cities'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=cities.size});
  ['stat-trips','m-stat-trips'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=filtered.length});

  // Country highlights
  if(geoJsonData){
    [...countries].forEach(vc=>{
      const en=ZH_TO_EN[vc]||vc;const color=getCountryColor(vc);
      geoJsonData.features.filter(f=>{const n=f.properties.ADMIN||f.properties.name||'';return n.toLowerCase()===en.toLowerCase()||n.includes(en)||en.includes(n)}).forEach(feat=>{
        const l=L.geoJSON(feat,{style:{fillColor:color,fillOpacity:.3,color:color,weight:2,opacity:.6}}).addTo(map);
        l.bindTooltip(vc,{sticky:true});countryLayers.push(l);
      });
    });
  }
  // Legend
  const legendEl=document.getElementById('legend-items');
  if(countries.size===0){document.getElementById('country-legend').style.display='none'}
  else{document.getElementById('country-legend').style.display='block';legendEl.innerHTML=[...countries].map(c=>`<div class="legend-item"><div class="legend-color" style="background:${getCountryColor(c)}"></div><span>${c}</span></div>`).join('')}

  // Markers
  filtered.forEach(trip=>{
    if(!trip.lat||!trip.lng)return;
    const icon=L.divIcon({className:'',html:`<div class="custom-marker">${trip.emoji||'ğŸ“'}</div>`,iconSize:[34,34],iconAnchor:[17,17]});
    const ph=(trip.photos||[]).map(p=>`<img src="${p}" onclick="event.stopPropagation();showLightbox('${p}')">`).join('');
    const ds=trip.dateStart+(trip.dateEnd?` â†’ ${trip.dateEnd}`:'');
    const popup=L.popup({maxWidth:300}).setContent(`<div class="trip-popup"><h3>${trip.place}</h3><div class="date">ğŸ“… ${ds} Â· ${trip.country}${trip.city?' Â· '+trip.city:''}</div>${trip.note?`<div class="note">${trip.note}</div>`:''}${ph?`<div class="photos">${ph}</div>`:''}<div class="actions"><button class="popup-btn popup-btn-edit" onclick="editTrip('${trip.id}')">${t('edit')}</button><button class="popup-btn popup-btn-del" onclick="deleteTrip('${trip.id}')">${t('delete')}</button></div></div>`);
    const m=L.marker([trip.lat,trip.lng],{icon}).addTo(map).bindPopup(popup);markers.push(m);
  });
  updateFilters();localStorage.setItem('travelsnap_trips',JSON.stringify(trips));
}
function updateFilters(){
  const years=[...new Set(trips.filter(t=>t.dateStart).map(t=>t.dateStart.substring(0,4)))].sort().reverse();
  const bar=document.getElementById('filter-bar');
  bar.innerHTML=`<button class="filter-chip ${currentFilter==='all'?'active':''}" onclick="setFilter('all')">${t('filterAll')}</button>`;
  years.forEach(y=>{bar.innerHTML+=`<button class="filter-chip ${currentFilter===y?'active':''}" onclick="setFilter('${y}')">${y}${t('filterYear')}</button>`});
}
function setFilter(f){currentFilter=f;render()}

// ===== Panel =====
function openAddPanel(){document.getElementById('panel-overlay').classList.add('active');document.getElementById('side-panel').classList.add('active');document.getElementById('panel-title-text').textContent=t('panelAdd');document.getElementById('edit-id').value='';uploadedPhotos=[];document.getElementById('photo-preview').innerHTML=''}
function closePanel(){document.getElementById('panel-overlay').classList.remove('active');document.getElementById('side-panel').classList.remove('active');document.getElementById('trip-form').reset();uploadedPhotos=[];document.getElementById('photo-preview').innerHTML=''}

async function saveTrip(e){
  e.preventDefault();const editId=document.getElementById('edit-id').value;
  let lat=+document.getElementById('inp-lat').value,lng=+document.getElementById('inp-lng').value;
  const place=document.getElementById('inp-place').value,country=document.getElementById('inp-country').value,city=document.getElementById('inp-city').value;
  if(isNaN(lat)||isNaN(lng)||!lat){const c=await geocode(`${place}, ${city||''} ${country}`);if(c){lat=c.lat;lng=c.lng}else{alert(t('geoFail'));return}}
  const trip={id:editId||Date.now().toString(),place,country,city,dateStart:document.getElementById('inp-date-start').value,dateEnd:document.getElementById('inp-date-end').value,note:document.getElementById('inp-note').value,photos:uploadedPhotos.slice(0,2),lat,lng,emoji:getEmoji(country)};
  if(editId){const i=trips.findIndex(t=>t.id===editId);if(i>=0)trips[i]=trip}else trips.push(trip);
  closePanel();render();map.flyTo([lat,lng],6,{duration:1.5});
}
function editTrip(id){const trip=trips.find(t=>t.id===id);if(!trip)return;map.closePopup();openAddPanel();document.getElementById('panel-title-text').textContent=t('panelEdit');document.getElementById('edit-id').value=id;document.getElementById('inp-place').value=trip.place;document.getElementById('inp-country').value=trip.country;document.getElementById('inp-city').value=trip.city||'';document.getElementById('inp-date-start').value=trip.dateStart;document.getElementById('inp-date-end').value=trip.dateEnd||'';document.getElementById('inp-note').value=trip.note||'';document.getElementById('inp-lat').value=trip.lat;document.getElementById('inp-lng').value=trip.lng;uploadedPhotos=trip.photos||[];renderPhotoPreview()}
function deleteTrip(id){if(!confirm(t('confirmDel')))return;trips=trips.filter(t=>t.id!==id);map.closePopup();render()}

function handlePhotos(input){Array.from(input.files).slice(0,2-uploadedPhotos.length).forEach(f=>{const r=new FileReader();r.onload=e=>{if(uploadedPhotos.length<2){uploadedPhotos.push(e.target.result);renderPhotoPreview()}};r.readAsDataURL(f)});input.value=''}
function renderPhotoPreview(){document.getElementById('photo-preview').innerHTML=uploadedPhotos.map((p,i)=>`<div class="photo-preview-item"><img src="${p}"><button class="remove" onclick="removePhoto(${i})">âœ•</button></div>`).join('')}
function removePhoto(i){uploadedPhotos.splice(i,1);renderPhotoPreview()}

function openList(){document.getElementById('list-overlay').classList.add('active');document.getElementById('list-panel').classList.add('active');const sorted=[...trips].sort((a,b)=>(b.dateStart||'').localeCompare(a.dateStart||''));const el=document.getElementById('trip-list');if(!sorted.length){el.innerHTML=`<div style="text-align:center;color:var(--text3);padding:40px">${t('noTrips')}</div>`;return}el.innerHTML=sorted.map(t=>`<div class="list-item" onclick="flyToTrip('${t.id}')"><div class="list-item-icon">${t.emoji||'ğŸ“'}</div><div class="list-item-info"><div class="list-item-name">${t.place}</div><div class="list-item-date">${t.dateStart||'?'} Â· ${t.country}${t.city?' Â· '+t.city:''}</div></div></div>`).join('')}
function closeList(){document.getElementById('list-overlay').classList.remove('active');document.getElementById('list-panel').classList.remove('active')}
function flyToTrip(id){const trip=trips.find(t=>t.id===id);if(!trip)return;closeList();map.flyTo([trip.lat,trip.lng],8,{duration:1});setTimeout(()=>{const m=markers.find(mk=>{const ll=mk.getLatLng();return Math.abs(ll.lat-trip.lat)<.001&&Math.abs(ll.lng-trip.lng)<.001});if(m)m.openPopup()},1200)}

function showLightbox(s){document.getElementById('lightbox-img').src=s;document.getElementById('lightbox').classList.add('active')}
function closeLightbox(){document.getElementById('lightbox').classList.remove('active')}

// ===== Export =====
let exportDataUrl=null;
async function exportImage(){
  if(!trips.length){alert(t('noData'));return}
  document.getElementById('export-overlay').classList.add('active');
  document.getElementById('export-preview').innerHTML=`<p style="color:var(--text3)">ğŸ¨ ${t('exportGen')}</p>`;
  const bounds=L.latLngBounds(trips.map(t=>[t.lat,t.lng]));map.fitBounds(bounds.pad(.2));
  const exportTooltips=[];markers.forEach((m,i)=>{const trip=trips.filter(t=>t.lat&&t.lng)[i];if(trip){m.bindTooltip(trip.place,{permanent:true,direction:'right',offset:[14,0],className:'exp-tip'});m.openTooltip();exportTooltips.push(m)}});
  const style=document.createElement('style');style.id='exp-s';style.textContent='.exp-tip{background:rgba(18,18,26,.9);border:1px solid rgba(99,102,241,.4);border-radius:8px;padding:3px 10px;font-size:12px;font-weight:600;color:#e2e8f0;box-shadow:0 2px 8px rgba(0,0,0,.3)}.exp-tip::before{display:none}';document.head.appendChild(style);
  const hideEls=['filter-bar','country-legend','mobile-stats','mobile-nav'].map(id=>document.getElementById(id)).filter(Boolean);
  hideEls.forEach(el=>el.style.display='none');document.querySelector('.header').style.display='none';document.querySelector('.lang-toggle').style.display='none';
  await new Promise(r=>setTimeout(r,2000));
  try{
    const countries=[...new Set(trips.map(t=>t.country))],cities=[...new Set(trips.filter(t=>t.city).map(t=>t.city))];
    const mapCanvas=await html2canvas(document.getElementById('map'),{useCORS:true,allowTaint:true,scale:2});
    const W=1080,H=1440,c=document.createElement('canvas');c.width=W*2;c.height=H*2;const ctx=c.getContext('2d');ctx.scale(2,2);
    // Dark gradient bg
    const bg=ctx.createLinearGradient(0,0,W,H);bg.addColorStop(0,'#0a0a0f');bg.addColorStop(1,'#12121a');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
    // Title
    ctx.textAlign='center';ctx.fillStyle='#e2e8f0';ctx.font='bold 36px Inter,PingFang SC,sans-serif';ctx.fillText(t('exportMyTrips'),W/2,52);
    ctx.fillStyle='#64748b';ctx.font='15px Inter,sans-serif';ctx.fillText(`${countries.length} ${t('countries')} Â· ${cities.length} ${t('cities')} Â· ${trips.length} ${t('trips')}`,W/2,78);
    // Map
    const mx=30,my=96,mw=W-60,mh=1060,r2=16;
    ctx.save();ctx.beginPath();ctx.moveTo(mx+r2,my);ctx.arcTo(mx+mw,my,mx+mw,my+mh,r2);ctx.arcTo(mx+mw,my+mh,mx,my+mh,r2);ctx.arcTo(mx,my+mh,mx,my,r2);ctx.arcTo(mx,my,mx+mw,my,r2);ctx.closePath();ctx.clip();ctx.drawImage(mapCanvas,mx,my,mw,mh);ctx.restore();
    // Border
    ctx.save();ctx.beginPath();ctx.moveTo(mx+r2,my);ctx.arcTo(mx+mw,my,mx+mw,my+mh,r2);ctx.arcTo(mx+mw,my+mh,mx,my+mh,r2);ctx.arcTo(mx,my+mh,mx,my,r2);ctx.arcTo(mx,my,mx+mw,my,r2);ctx.closePath();ctx.strokeStyle='rgba(99,102,241,.3)';ctx.lineWidth=1;ctx.stroke();ctx.restore();
    // Tags
    ctx.font='13px Inter,PingFang SC,sans-serif';let tx=(W-countries.reduce((a,c2)=>a+ctx.measureText(`${getEmoji(c2)} ${c2}`).width+34,0)-10*(countries.length-1))/2;
    countries.forEach(c2=>{const color=getCountryColor(c2);const text=`${getEmoji(c2)} ${c2}`;const tw=ctx.measureText(text).width+24;ctx.fillStyle=color+'33';ctx.beginPath();ctx.roundRect(tx,1186,tw,30,15);ctx.fill();ctx.strokeStyle=color+'55';ctx.lineWidth=1;ctx.stroke();ctx.fillStyle=color;ctx.textAlign='left';ctx.fillText(text,tx+12,1206);tx+=tw+10});
    ctx.textAlign='center';ctx.fillStyle='#475569';ctx.font='12px Inter,sans-serif';ctx.fillText(`TravelSnap Â· ${new Date().getFullYear()}`,W/2,1420);
    exportDataUrl=c.toDataURL('image/png');document.getElementById('export-preview').innerHTML=`<img src="${exportDataUrl}" style="width:100%;border-radius:12px">`;
  }catch(e){document.getElementById('export-preview').innerHTML=`<p style="color:#ef4444">Error: ${e.message}</p>`}
  hideEls.forEach(el=>el.style.display='');document.querySelector('.header').style.display='';document.querySelector('.lang-toggle').style.display='';
  exportTooltips.forEach(m=>m.unbindTooltip());document.getElementById('exp-s')?.remove();render();
}
function downloadExport(){if(!exportDataUrl)return;const a=document.createElement('a');a.href=exportDataUrl;a.download=`TravelSnap_${new Date().toISOString().slice(0,10)}.png`;a.click()}
function closeExport(){document.getElementById('export-overlay').classList.remove('active')}

// ===== Emoji =====
function getEmoji(c){const m={'ä¸­å›½':'ğŸ‡¨ğŸ‡³','ç¾å›½':'ğŸ‡ºğŸ‡¸','æ—¥æœ¬':'ğŸ‡¯ğŸ‡µ','éŸ©å›½':'ğŸ‡°ğŸ‡·','æ³•å›½':'ğŸ‡«ğŸ‡·','å¾·å›½':'ğŸ‡©ğŸ‡ª','è‹±å›½':'ğŸ‡¬ğŸ‡§','æ„å¤§åˆ©':'ğŸ‡®ğŸ‡¹','è¥¿ç­ç‰™':'ğŸ‡ªğŸ‡¸','æ¾³å¤§åˆ©äºš':'ğŸ‡¦ğŸ‡º','åŠ æ‹¿å¤§':'ğŸ‡¨ğŸ‡¦','æ–°åŠ å¡':'ğŸ‡¸ğŸ‡¬','æ³°å›½':'ğŸ‡¹ğŸ‡­','è¶Šå—':'ğŸ‡»ğŸ‡³','å°åº¦':'ğŸ‡®ğŸ‡³','å·´è¥¿':'ğŸ‡§ğŸ‡·','å¢¨è¥¿å“¥':'ğŸ‡²ğŸ‡½','åŸƒåŠ':'ğŸ‡ªğŸ‡¬','åœŸè€³å…¶':'ğŸ‡¹ğŸ‡·','å¸Œè…Š':'ğŸ‡¬ğŸ‡·','ç‘å£«':'ğŸ‡¨ğŸ‡­','China':'ğŸ‡¨ğŸ‡³','USA':'ğŸ‡ºğŸ‡¸','Japan':'ğŸ‡¯ğŸ‡µ','Korea':'ğŸ‡°ğŸ‡·','France':'ğŸ‡«ğŸ‡·','Germany':'ğŸ‡©ğŸ‡ª','UK':'ğŸ‡¬ğŸ‡§','Italy':'ğŸ‡®ğŸ‡¹','Spain':'ğŸ‡ªğŸ‡¸','Singapore':'ğŸ‡¸ğŸ‡¬','Thailand':'ğŸ‡¹ğŸ‡­','India':'ğŸ‡®ğŸ‡³','Brazil':'ğŸ‡§ğŸ‡·','Canada':'ğŸ‡¨ğŸ‡¦','Australia':'ğŸ‡¦ğŸ‡º','è·å…°':'ğŸ‡³ğŸ‡±','è‘¡è„ç‰™':'ğŸ‡µğŸ‡¹','ä¿„ç½—æ–¯':'ğŸ‡·ğŸ‡º','é©¬æ¥è¥¿äºš':'ğŸ‡²ğŸ‡¾','å°å°¼':'ğŸ‡®ğŸ‡©','æ–°è¥¿å…°':'ğŸ‡³ğŸ‡¿','å¥¥åœ°åˆ©':'ğŸ‡¦ğŸ‡¹','ç‘å…¸':'ğŸ‡¸ğŸ‡ª','æŒªå¨':'ğŸ‡³ğŸ‡´','ä¸¹éº¦':'ğŸ‡©ğŸ‡°','èŠ¬å…°':'ğŸ‡«ğŸ‡®','å†°å²›':'ğŸ‡®ğŸ‡¸','æ·å…‹':'ğŸ‡¨ğŸ‡¿','æ³¢å…°':'ğŸ‡µğŸ‡±','åŒˆç‰™åˆ©':'ğŸ‡­ğŸ‡º','å—é':'ğŸ‡¿ğŸ‡¦','é˜¿è”é…‹':'ğŸ‡¦ğŸ‡ª','ä»¥è‰²åˆ—':'ğŸ‡®ğŸ‡±','å°æ¹¾':'ğŸ‡¹ğŸ‡¼','çˆ±å°”å…°':'ğŸ‡®ğŸ‡ª'};return m[c]||'ğŸ“'}

// ===== Init =====
async function init(){
  await loadGeoJson();
  if(!trips.length){trips=[{id:'1',place:'æ³¢ç‰¹å…°',country:'ç¾å›½',city:'Portland',dateStart:'2025-01-01',note:'å®¶ ğŸ ',photos:[],lat:45.5155,lng:-122.6789,emoji:'ğŸ‡ºğŸ‡¸'},{id:'2',place:'å—äº¬',country:'ä¸­å›½',city:'å—äº¬',dateStart:'2025-06-15',dateEnd:'2025-06-30',note:'å›è€å®¶æ¢äº²',photos:[],lat:32.0603,lng:118.7969,emoji:'ğŸ‡¨ğŸ‡³'}]}
  applyLang();render();
}
init();
</script>
</body>
</html>

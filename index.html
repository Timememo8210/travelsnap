<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TravelSnap ğŸŒ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --primary: #2563eb;
  --primary-dark: #1d4ed8;
  --bg: #f8fafc;
  --card: #ffffff;
  --card-hover: #f1f5f9;
  --text: #1e293b;
  --text-dim: #64748b;
  --accent: #2563eb;
  --success: #16a34a;
  --danger: #dc2626;
  --border: #e2e8f0;
  --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
}
body { font-family: -apple-system, 'PingFang SC', 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; }

.glass {
  background: rgba(255,255,255,0.72) !important;
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
}
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 20px; background: rgba(255,255,255,0.75); border-bottom: 1px solid rgba(226,232,240,0.6);
  position: relative; z-index: 1000;
  backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
}
.logo { font-size: 20px; font-weight: 700; }
.logo span { color: var(--accent); }
.header-stats { display: flex; gap: 24px; font-size: 12px; color: var(--text-dim); letter-spacing: 0.3px; }
.header-stats .num { color: var(--accent); font-weight: 800; font-size: 22px; display: block; line-height: 1; }
.header-actions { display: flex; gap: 6px; align-items: center; }

.btn {
  padding: 7px 14px; border: none; border-radius: 8px; font-size: 12px;
  cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 5px;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-outline { background: var(--card); color: var(--text-dim); border: 1px solid var(--border); }
.btn-outline:hover { background: var(--card-hover); color: var(--text); }

.lang-toggle {
  padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border); background: var(--card); color: var(--text-dim);
  transition: all 0.2s;
}
.lang-toggle:hover { background: var(--card-hover); }

#map { height: calc(100vh - 52px); width: 100%; }
.leaflet-container { background: #e8f0fe; }
.country-name-label span {
  font-size: 11px; font-weight: 600; color: #475569;
  white-space: nowrap; text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white;
  pointer-events: none;
}

.custom-marker {
  background: white; color: var(--text); border-radius: 50%; width: 34px; height: 34px;
  display: flex; align-items: center; justify-content: center; font-size: 17px;
  border: 3px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}
.custom-marker:hover { transform: scale(1.2); }

.trip-popup { min-width: 240px; }
.trip-popup h3 { font-size: 15px; margin-bottom: 4px; color: #1e293b; }
.trip-popup .date { font-size: 12px; color: #64748b; margin-bottom: 6px; }
.trip-popup .note { font-size: 13px; color: #475569; margin-bottom: 8px; line-height: 1.5; }
.trip-popup .photos { display: flex; gap: 6px; margin-bottom: 8px; }
.trip-popup .photos img { width: 100px; height: 70px; object-fit: cover; border-radius: 6px; cursor: pointer; }
.trip-popup .actions { display: flex; gap: 6px; }
.popup-btn { padding: 4px 10px; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 500; }
.popup-btn-edit { background: #dbeafe; color: #1d4ed8; }
.popup-btn-del { background: #fee2e2; color: #dc2626; }

.panel-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 2000; display: none; }
.panel-overlay.active { display: block; }
.side-panel {
  position: fixed; top: 0; right: -420px; width: 400px; height: 100vh;
  background: rgba(255,255,255,0.85); backdrop-filter: blur(24px) saturate(180%); -webkit-backdrop-filter: blur(24px) saturate(180%);
  z-index: 2001; transition: right 0.3s ease;
  overflow-y: auto; padding: 24px; box-shadow: -4px 0 24px rgba(0,0,0,0.08);
}
.side-panel.active { right: 0; }
.panel-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.panel-close { background: none; border: none; color: var(--text-dim); font-size: 22px; cursor: pointer; }

.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 13px; color: var(--text-dim); margin-bottom: 5px; font-weight: 500; }
.form-input {
  width: 100%; padding: 9px 12px; background: var(--bg); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text); font-size: 14px; outline: none; transition: border 0.2s;
}
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
textarea.form-input { resize: vertical; min-height: 70px; }
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }

.photo-upload {
  border: 2px dashed var(--border); border-radius: 8px; padding: 18px;
  text-align: center; cursor: pointer; transition: border-color 0.2s;
}
.photo-upload:hover { border-color: var(--accent); }
.photo-upload-icon { font-size: 28px; margin-bottom: 6px; }
.photo-upload-text { font-size: 12px; color: var(--text-dim); }
.photo-preview { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
.photo-preview-item { position: relative; }
.photo-preview-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 6px; }
.photo-preview-item .remove {
  position: absolute; top: -6px; right: -6px; width: 20px; height: 20px;
  background: var(--danger); color: white; border: none; border-radius: 50%;
  font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;
}

.filter-bar {
  position: absolute; top: 64px; left: 50%; transform: translateX(-50%);
  z-index: 1000; display: flex; gap: 6px;
  background: rgba(255,255,255,0.7); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%);
  padding: 6px 14px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5);
}
.filter-chip {
  padding: 5px 12px; border-radius: 20px; font-size: 12px; border: 1px solid var(--border);
  background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.2s;
}
.filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
.filter-chip:hover { border-color: var(--accent); }

/* Country legend */
.country-legend {
  position: absolute; bottom: 30px; left: 16px; z-index: 1000;
  background: rgba(255,255,255,0.7); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%);
  border-radius: 10px; padding: 12px 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid rgba(255,255,255,0.5);
  max-width: 200px; font-size: 12px;
}
.country-legend h4 { font-size: 13px; margin-bottom: 8px; color: var(--text); }
.legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.legend-color { width: 16px; height: 16px; border-radius: 4px; flex-shrink: 0; }

.export-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
.export-overlay.active { display: flex; }
.export-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(24px) saturate(180%); -webkit-backdrop-filter: blur(24px) saturate(180%); border: 1px solid rgba(255,255,255,0.5); border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; text-align: center; }
.export-card h3 { margin-bottom: 12px; }
.export-preview { margin: 12px 0; border-radius: 8px; overflow: hidden; }
.export-preview img { width: 100%; }
.export-actions { display: flex; gap: 10px; justify-content: center; }

.list-item {
  display: flex; align-items: center; gap: 12px; padding: 12px;
  background: var(--bg); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s;
}
.list-item:hover { background: var(--card-hover); }
.list-item-icon { font-size: 22px; }
.list-item-info { flex: 1; }
.list-item-name { font-size: 14px; font-weight: 600; }
.list-item-date { font-size: 12px; color: var(--text-dim); }

.lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; cursor: pointer; }
.lightbox.active { display: flex; }
.lightbox img { max-width: 90%; max-height: 90%; border-radius: 8px; }

/* Mobile bottom nav */
.mobile-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
  background: rgba(255,255,255,0.75); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-top: 1px solid rgba(226,232,240,0.5);
  padding: 8px 12px calc(8px + env(safe-area-inset-bottom, 0px)) 12px;
  box-shadow: 0 -2px 16px rgba(0,0,0,0.06);
}
.mobile-nav-inner { display: flex; gap: 8px; }
.mobile-nav .btn { flex: 1; justify-content: center; min-height: 46px; font-size: 14px; border-radius: 12px; }
.mobile-nav .btn-primary { font-size: 15px; }

/* Stats card (mobile) */
.mobile-stats {
  display: none; position: absolute; top: 64px; right: 12px; z-index: 1000;
  background: rgba(255,255,255,0.7); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%);
  border-radius: 14px; padding: 14px 18px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06); border: 1px solid rgba(255,255,255,0.5); gap: 16px;
}
.mobile-stats .stat-item { text-align: center; }
.mobile-stats .stat-num { font-size: 26px; font-weight: 800; color: var(--accent); line-height: 1; }
.mobile-stats .stat-label { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

@media (max-width: 768px) {
  .header-stats { display: none; }
  .header-actions .btn { display: none; }
  .header-actions .lang-toggle { display: inline-block; }
  .mobile-nav { display: block; }
  .mobile-stats { display: flex; }
  .side-panel { width: 100%; right: -100%; padding: 20px; padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)); }
  .filter-bar { width: 92%; overflow-x: auto; top: 62px; left: 4%; transform: none; }
  .country-legend { bottom: 80px; max-width: 160px; padding: 10px 12px; font-size: 11px; }
  #map { height: calc(100vh - 52px - 62px); }
  .form-input { padding: 12px 14px; font-size: 15px; border-radius: 10px; }
  textarea.form-input { min-height: 80px; }
  .btn { min-height: 46px; border-radius: 10px; }
  .photo-upload { padding: 24px; }
  .list-item { padding: 14px; border-radius: 10px; }
  .list-item-name { font-size: 15px; }
}
</style>
</head>
<body>

<div class="header">
  <div class="logo">ğŸŒ Travel<span>Snap</span></div>
  <div class="header-stats">
    <div><span class="num" id="stat-countries">0</span> <span data-i18n="countries">ä¸ªå›½å®¶</span></div>
    <div><span class="num" id="stat-cities">0</span> <span data-i18n="cities">ä¸ªåŸå¸‚</span></div>
    <div><span class="num" id="stat-trips">0</span> <span data-i18n="trips">æ¬¡æ—…è¡Œ</span></div>
  </div>
  <div class="header-actions">
    <button class="lang-toggle" onclick="toggleLang()" id="lang-btn">EN</button>
    <button class="btn btn-outline" onclick="openList()" data-i18n="btnList">ğŸ“‹ è¶³è¿¹åˆ—è¡¨</button>
    <button class="btn btn-outline" onclick="exportImage()" data-i18n="btnExport">ğŸ“¤ å¯¼å‡ºåˆ†äº«</button>
    <button class="btn btn-primary" onclick="openAddPanel()" data-i18n="btnAdd">ï¼‹ æ·»åŠ è¶³è¿¹</button>
  </div>
</div>

<div class="filter-bar" id="filter-bar">
  <button class="filter-chip active" onclick="setFilter('all', this)" data-i18n="filterAll">å…¨éƒ¨</button>
</div>

<div id="map"></div>

<!-- Mobile stats overlay -->
<div class="mobile-stats" id="mobile-stats">
  <div class="stat-item"><div class="stat-num" id="m-stat-countries">0</div><div class="stat-label" data-i18n="countries">ä¸ªå›½å®¶</div></div>
  <div class="stat-item"><div class="stat-num" id="m-stat-cities">0</div><div class="stat-label" data-i18n="cities">ä¸ªåŸå¸‚</div></div>
  <div class="stat-item"><div class="stat-num" id="m-stat-trips">0</div><div class="stat-label" data-i18n="trips">æ¬¡æ—…è¡Œ</div></div>
</div>

<!-- Mobile bottom nav -->
<div class="mobile-nav">
  <div class="mobile-nav-inner">
    <button class="btn btn-outline" onclick="openList()" data-i18n="btnList">ğŸ“‹ åˆ—è¡¨</button>
    <button class="btn btn-primary" onclick="openAddPanel()" data-i18n="btnAdd">ï¼‹ æ·»åŠ è¶³è¿¹</button>
    <button class="btn btn-outline" onclick="exportImage()" data-i18n="btnExport">ğŸ“¤ å¯¼å‡º</button>
  </div>
</div>

<!-- Legend -->
<div class="country-legend" id="country-legend">
  <h4 data-i18n="legendTitle">ğŸ—ºï¸ åˆ°è®¿å›½å®¶</h4>
  <div id="legend-items"></div>
</div>

<!-- Add/Edit Panel -->
<div class="panel-overlay" id="panel-overlay" onclick="closePanel()"></div>
<div class="side-panel" id="side-panel">
  <div class="panel-title">
    <span id="panel-title-text" data-i18n="panelAdd">âœˆï¸ æ·»åŠ æ–°è¶³è¿¹</span>
    <button class="panel-close" onclick="closePanel()">âœ•</button>
  </div>
  <form id="trip-form" onsubmit="saveTrip(event)">
    <input type="hidden" id="edit-id" value="">
    <div class="form-group">
      <label class="form-label" data-i18n="labelPlace">ğŸ“ åœ°ç‚¹åç§° *</label>
      <input type="text" class="form-input" id="inp-place" data-i18n-ph="phPlace" placeholder="å¦‚ï¼šå·´é»ã€ä¸œäº¬å¡”" required>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" data-i18n="labelCountry">ğŸŒ å›½å®¶ *</label>
        <input type="text" class="form-input" id="inp-country" data-i18n-ph="phCountry" placeholder="å¦‚ï¼šæ³•å›½" required>
      </div>
      <div class="form-group">
        <label class="form-label" data-i18n="labelCity">ğŸ™ï¸ åŸå¸‚</label>
        <input type="text" class="form-input" id="inp-city" data-i18n-ph="phCity" placeholder="å¦‚ï¼šå·´é»">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" data-i18n="labelStart">ğŸ“… å¼€å§‹æ—¥æœŸ *</label>
        <input type="date" class="form-input" id="inp-date-start" required>
      </div>
      <div class="form-group">
        <label class="form-label" data-i18n="labelEnd">ğŸ“… ç»“æŸæ—¥æœŸ</label>
        <input type="date" class="form-input" id="inp-date-end">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="labelNote">ğŸ“ æ—…è¡Œç¬”è®°</label>
      <textarea class="form-input" id="inp-note" data-i18n-ph="phNote" placeholder="è®°å½•ä½ çš„æ—…è¡Œæ„Ÿå—..."></textarea>
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="labelPhoto">ğŸ“¸ ç…§ç‰‡ï¼ˆæœ€å¤š2å¼ ï¼‰</label>
      <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
        <div class="photo-upload-icon">ğŸ“·</div>
        <div class="photo-upload-text" data-i18n="photoUpload">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div>
      </div>
      <input type="file" id="photo-input" accept="image/*" multiple style="display:none" onchange="handlePhotos(this)">
      <div class="photo-preview" id="photo-preview"></div>
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="labelCoord">ğŸ“Œ åœ°å›¾åæ ‡ï¼ˆå¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨æœç´¢ï¼‰</label>
      <div class="form-row">
        <input type="number" step="any" class="form-input" id="inp-lat" data-i18n-ph="phLat" placeholder="çº¬åº¦">
        <input type="number" step="any" class="form-input" id="inp-lng" data-i18n-ph="phLng" placeholder="ç»åº¦">
      </div>
      <div style="font-size:11px;color:var(--text-dim);margin-top:4px" data-i18n="coordTip">ğŸ’¡ ä¹Ÿå¯ä»¥åœ¨åœ°å›¾ä¸Šå³é”®ç‚¹å‡»è·å–åæ ‡</div>
    </div>
    <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;" data-i18n="btnSave">ğŸ’¾ ä¿å­˜è¶³è¿¹</button>
  </form>
</div>

<!-- List Panel -->
<div class="panel-overlay" id="list-overlay" onclick="closeList()"></div>
<div class="side-panel" id="list-panel">
  <div class="panel-title">
    <span data-i18n="myFootprints">ğŸ“‹ æˆ‘çš„è¶³è¿¹</span>
    <button class="panel-close" onclick="closeList()">âœ•</button>
  </div>
  <div id="trip-list"></div>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src=""></div>

<div class="export-overlay" id="export-overlay">
  <div class="export-card">
    <h3 data-i18n="exportTitle">ğŸ“¤ å¯¼å‡ºåˆ†äº«å›¾</h3>
    <p style="color:var(--text-dim);font-size:13px;margin-bottom:12px" data-i18n="exportGen">æ­£åœ¨ç”Ÿæˆç²¾ç¾åˆ†äº«å›¾...</p>
    <div class="export-preview" id="export-preview"></div>
    <div class="export-actions">
      <button class="btn btn-outline" onclick="closeExport()" data-i18n="close">å…³é—­</button>
      <button class="btn btn-primary" onclick="downloadExport()" data-i18n="download">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
    </div>
  </div>
</div>

<script>
// ===== i18n =====
let lang = localStorage.getItem('travelsnap_lang') || 'zh';
const I18N = {
  zh: {
    countries: 'ä¸ªå›½å®¶', cities: 'ä¸ªåŸå¸‚', trips: 'æ¬¡æ—…è¡Œ',
    btnList: 'ğŸ“‹ è¶³è¿¹åˆ—è¡¨', btnExport: 'ğŸ“¤ å¯¼å‡ºåˆ†äº«', btnAdd: 'ï¼‹ æ·»åŠ è¶³è¿¹',
    filterAll: 'å…¨éƒ¨', filterYear: 'å¹´',
    legendTitle: 'ğŸ—ºï¸ åˆ°è®¿å›½å®¶',
    panelAdd: 'âœˆï¸ æ·»åŠ æ–°è¶³è¿¹', panelEdit: 'âœï¸ ç¼–è¾‘è¶³è¿¹',
    labelPlace: 'ğŸ“ åœ°ç‚¹åç§° *', labelCountry: 'ğŸŒ å›½å®¶ *', labelCity: 'ğŸ™ï¸ åŸå¸‚',
    labelStart: 'ğŸ“… å¼€å§‹æ—¥æœŸ *', labelEnd: 'ğŸ“… ç»“æŸæ—¥æœŸ', labelNote: 'ğŸ“ æ—…è¡Œç¬”è®°',
    labelPhoto: 'ğŸ“¸ ç…§ç‰‡ï¼ˆæœ€å¤š2å¼ ï¼‰', labelCoord: 'ğŸ“Œ åœ°å›¾åæ ‡ï¼ˆå¯é€‰ï¼‰',
    phPlace: 'å¦‚ï¼šå·´é»ã€ä¸œäº¬å¡”', phCountry: 'å¦‚ï¼šæ³•å›½', phCity: 'å¦‚ï¼šå·´é»',
    phNote: 'è®°å½•ä½ çš„æ—…è¡Œæ„Ÿå—...', phLat: 'çº¬åº¦', phLng: 'ç»åº¦',
    coordTip: 'ğŸ’¡ ä¹Ÿå¯ä»¥åœ¨åœ°å›¾ä¸Šå³é”®ç‚¹å‡»è·å–åæ ‡',
    photoUpload: 'ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡', btnSave: 'ğŸ’¾ ä¿å­˜è¶³è¿¹',
    myFootprints: 'ğŸ“‹ æˆ‘çš„è¶³è¿¹', noTrips: 'è¿˜æ²¡æœ‰è¶³è¿¹ï¼Œç‚¹å‡»"æ·»åŠ è¶³è¿¹"å¼€å§‹å§ï¼',
    unknownDate: 'æœªçŸ¥æ—¥æœŸ', edit: 'âœï¸ ç¼–è¾‘', delete: 'ğŸ—‘ï¸ åˆ é™¤',
    confirmDel: 'ç¡®å®šåˆ é™¤è¿™ä¸ªè¶³è¿¹å—ï¼Ÿ', geoFail: 'æ— æ³•å®šä½ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥åæ ‡æˆ–å³é”®åœ°å›¾',
    exportTitle: 'ğŸ“¤ å¯¼å‡ºåˆ†äº«å›¾', exportGen: 'æ­£åœ¨ç”Ÿæˆ...', close: 'å…³é—­', download: 'ğŸ’¾ ä¸‹è½½å›¾ç‰‡',
    noData: 'è¿˜æ²¡æœ‰è¶³è¿¹æ•°æ®ï¼', exportMyTrips: 'ğŸŒ æˆ‘çš„æ—…è¡Œè¶³è¿¹',
  },
  en: {
    countries: 'Countries', cities: 'Cities', trips: 'Trips',
    btnList: 'ğŸ“‹ List', btnExport: 'ğŸ“¤ Export', btnAdd: 'ï¼‹ Add Trip',
    filterAll: 'All', filterYear: '',
    legendTitle: 'ğŸ—ºï¸ Visited Countries',
    panelAdd: 'âœˆï¸ Add New Trip', panelEdit: 'âœï¸ Edit Trip',
    labelPlace: 'ğŸ“ Place Name *', labelCountry: 'ğŸŒ Country *', labelCity: 'ğŸ™ï¸ City',
    labelStart: 'ğŸ“… Start Date *', labelEnd: 'ğŸ“… End Date', labelNote: 'ğŸ“ Travel Notes',
    labelPhoto: 'ğŸ“¸ Photos (max 2)', labelCoord: 'ğŸ“Œ Coordinates (optional)',
    phPlace: 'e.g. Paris, Tokyo Tower', phCountry: 'e.g. France', phCity: 'e.g. Paris',
    phNote: 'Write about your trip...', phLat: 'Latitude', phLng: 'Longitude',
    coordTip: 'ğŸ’¡ Right-click on map to get coordinates',
    photoUpload: 'Click to upload', btnSave: 'ğŸ’¾ Save Trip',
    myFootprints: 'ğŸ“‹ My Trips', noTrips: 'No trips yet. Click "Add Trip" to start!',
    unknownDate: 'Unknown date', edit: 'âœï¸ Edit', delete: 'ğŸ—‘ï¸ Delete',
    confirmDel: 'Delete this trip?', geoFail: 'Cannot locate. Please enter coordinates or right-click map.',
    exportTitle: 'ğŸ“¤ Export Share Image', exportGen: 'Generating...', close: 'Close', download: 'ğŸ’¾ Download',
    noData: 'No trip data yet!', exportMyTrips: 'ğŸŒ My Travel Map',
  }
};

function t(key) { return I18N[lang][key] || key; }

function applyLang() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (I18N[lang][key]) el.textContent = I18N[lang][key];
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    const key = el.getAttribute('data-i18n-ph');
    if (I18N[lang][key]) el.placeholder = I18N[lang][key];
  });
  document.getElementById('lang-btn').textContent = lang === 'zh' ? 'EN' : 'ä¸­æ–‡';
}

function toggleLang() {
  lang = lang === 'zh' ? 'en' : 'zh';
  localStorage.setItem('travelsnap_lang', lang);
  applyLang();
  setMapTiles();
  render();
}

// ===== COUNTRY COLORS =====
const COUNTRY_COLORS = [
  '#3b82f6','#8b5cf6','#ec4899','#f59e0b','#10b981','#06b6d4',
  '#ef4444','#84cc16','#f97316','#6366f1','#14b8a6','#e11d48',
  '#a855f7','#0ea5e9','#22c55e','#eab308'
];
let countryColorMap = {};

function getCountryColor(country) {
  if (!countryColorMap[country]) {
    const idx = Object.keys(countryColorMap).length % COUNTRY_COLORS.length;
    countryColorMap[country] = COUNTRY_COLORS[idx];
  }
  return countryColorMap[country];
}

// ===== DATA =====
let trips = JSON.parse(localStorage.getItem('travelsnap_trips') || '[]');
let uploadedPhotos = [];
let currentFilter = 'all';
let markers = [];
let countryLayers = [];
let geoJsonData = null;

// ===== MAP =====
const map = L.map('map', { center: [30, 110], zoom: 3, zoomControl: false });
L.control.zoom({ position: 'bottomright' }).addTo(map);

// Tile layers (CN vs EN)
let currentTileLayer = null;
const TILE_ZH = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'; // default (English labels)
// Chinese label tiles via CartoDB + language param
const TILE_EN = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
// Use OSM-based Chinese tile for zh
const TILE_ZH_URL = 'https://tile.openstreetmap.bzh/br/{z}/{x}/{y}.png';

function setMapTiles() {
  if (currentTileLayer) map.removeLayer(currentTileLayer);
  if (lang === 'zh') {
    // Use CARTO Voyager (light style) - no label layer, then overlay country names via GeoJSON tooltips
    currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© OpenStreetMap Â© CARTO', maxZoom: 19, subdomains: 'abcd'
    }).addTo(map);
  } else {
    currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© OpenStreetMap Â© CARTO', maxZoom: 19, subdomains: 'abcd'
    }).addTo(map);
  }
}
setMapTiles();

map.on('contextmenu', function(e) {
  document.getElementById('inp-lat').value = e.latlng.lat.toFixed(6);
  document.getElementById('inp-lng').value = e.latlng.lng.toFixed(6);
  openAddPanel();
});

// ===== LOAD GEOJSON =====
async function loadGeoJson() {
  try {
    const res = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
    geoJsonData = await res.json();
  } catch(e) { console.error('GeoJSON load error', e); }
}

// Reverse name map (English â†’ Chinese)
const EN_TO_ZH = {
  'China':'ä¸­å›½','United States of America':'ç¾å›½','Japan':'æ—¥æœ¬','South Korea':'éŸ©å›½',
  'France':'æ³•å›½','Germany':'å¾·å›½','United Kingdom':'è‹±å›½','Italy':'æ„å¤§åˆ©','Spain':'è¥¿ç­ç‰™',
  'Australia':'æ¾³å¤§åˆ©äºš','Canada':'åŠ æ‹¿å¤§','Singapore':'æ–°åŠ å¡','Thailand':'æ³°å›½',
  'Vietnam':'è¶Šå—','India':'å°åº¦','Brazil':'å·´è¥¿','Mexico':'å¢¨è¥¿å“¥','Egypt':'åŸƒåŠ',
  'Turkey':'åœŸè€³å…¶','Greece':'å¸Œè…Š','Switzerland':'ç‘å£«','Netherlands':'è·å…°',
  'Portugal':'è‘¡è„ç‰™','Russia':'ä¿„ç½—æ–¯','Malaysia':'é©¬æ¥è¥¿äºš','Indonesia':'å°å°¼',
  'New Zealand':'æ–°è¥¿å…°','Austria':'å¥¥åœ°åˆ©','Sweden':'ç‘å…¸','Norway':'æŒªå¨',
  'Denmark':'ä¸¹éº¦','Finland':'èŠ¬å…°','Iceland':'å†°å²›','Czech Republic':'æ·å…‹',
  'Poland':'æ³¢å…°','Hungary':'åŒˆç‰™åˆ©','Cambodia':'æŸ¬åŸ”å¯¨','Myanmar':'ç¼…ç”¸',
  'Philippines':'è²å¾‹å®¾','South Africa':'å—é','United Arab Emirates':'é˜¿è”é…‹',
  'Israel':'ä»¥è‰²åˆ—','Taiwan':'å°æ¹¾','Ireland':'çˆ±å°”å…°','Belgium':'æ¯”åˆ©æ—¶',
  'Argentina':'é˜¿æ ¹å»·','Chile':'æ™ºåˆ©','Peru':'ç§˜é²','Colombia':'å“¥ä¼¦æ¯”äºš',
  'Cuba':'å¤å·´','Sri Lanka':'æ–¯é‡Œå…°å¡','Nepal':'å°¼æ³Šå°”','Morocco':'æ‘©æ´›å“¥','Jordan':'çº¦æ—¦',
};

const ZH_TO_EN = {};
Object.entries(EN_TO_ZH).forEach(([en, zh]) => ZH_TO_EN[zh] = en);

let countryNameLabels = [];

function renderCountryHighlights() {
  countryLayers.forEach(l => map.removeLayer(l));
  countryLayers = [];
  countryNameLabels.forEach(l => map.removeLayer(l));
  countryNameLabels = [];
  if (!geoJsonData) return;

  const filtered = currentFilter === 'all' ? trips : trips.filter(t => t.dateStart && t.dateStart.startsWith(currentFilter));
  const visitedCountries = [...new Set(filtered.map(t => t.country))];

  visitedCountries.forEach(vc => {
    const enName = ZH_TO_EN[vc] || vc;
    const color = getCountryColor(vc);

    const features = geoJsonData.features.filter(f => {
      const name = f.properties.ADMIN || f.properties.name || '';
      return name.toLowerCase() === enName.toLowerCase() ||
             (f.properties.ISO_A3 && f.properties.ISO_A3 === enName) ||
             name.includes(enName) || enName.includes(name);
    });

    features.forEach(feat => {
      const layer = L.geoJSON(feat, {
        style: { fillColor: color, fillOpacity: 0.35, color: color, weight: 2, opacity: 0.7 }
      }).addTo(map);
      layer.bindTooltip(vc, { sticky: true, className: '' });
      countryLayers.push(layer);
    });
  });

  // In Chinese mode (no-labels base map), add country name labels for ALL visible countries
  if (lang === 'zh' && geoJsonData) {
    geoJsonData.features.forEach(feat => {
      const enName = feat.properties.ADMIN || feat.properties.name || '';
      const zhName = EN_TO_ZH[enName];
      if (!zhName) return;
      // Get centroid roughly
      const bounds = L.geoJSON(feat).getBounds();
      const center = bounds.getCenter();
      const label = L.marker(center, {
        icon: L.divIcon({
          className: 'country-name-label',
          html: `<span>${zhName}</span>`,
          iconSize: [0, 0]
        }),
        interactive: false
      }).addTo(map);
      countryNameLabels.push(label);
    });
  }

  // Update legend
  const legendEl = document.getElementById('legend-items');
  if (visitedCountries.length === 0) {
    document.getElementById('country-legend').style.display = 'none';
  } else {
    document.getElementById('country-legend').style.display = 'block';
    legendEl.innerHTML = visitedCountries.map(c =>
      `<div class="legend-item"><div class="legend-color" style="background:${getCountryColor(c)}"></div><span>${c}</span></div>`
    ).join('');
  }
}

// ===== GEOCODING =====
async function geocode(query) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
    const data = await res.json();
    if (data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
  } catch(e) {}
  return null;
}

// ===== RENDER =====
function render() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const filtered = currentFilter === 'all' ? trips : trips.filter(t => t.dateStart && t.dateStart.startsWith(currentFilter));

  const countries = new Set(filtered.map(t => t.country));
  const cities = new Set(filtered.filter(t => t.city).map(t => t.city));
  document.getElementById('stat-countries').textContent = countries.size;
  document.getElementById('stat-cities').textContent = cities.size;
  document.getElementById('stat-trips').textContent = filtered.length;
  // Mobile stats
  const mc = document.getElementById('m-stat-countries');
  if (mc) { mc.textContent = countries.size; document.getElementById('m-stat-cities').textContent = cities.size; document.getElementById('m-stat-trips').textContent = filtered.length; }

  filtered.forEach(trip => {
    if (!trip.lat || !trip.lng) return;
    const icon = L.divIcon({
      className: '',
      html: `<div class="custom-marker">${trip.emoji || 'ğŸ“'}</div>`,
      iconSize: [34, 34], iconAnchor: [17, 17]
    });

    const photoHtml = (trip.photos || []).map(p =>
      `<img src="${p}" onclick="event.stopPropagation();showLightbox('${p}')">`
    ).join('');
    const dateStr = trip.dateStart + (trip.dateEnd ? ` â†’ ${trip.dateEnd}` : '');

    const popup = L.popup({ maxWidth: 300 }).setContent(`
      <div class="trip-popup">
        <h3>${trip.place}</h3>
        <div class="date">ğŸ“… ${dateStr} Â· ${trip.country}${trip.city ? ' Â· ' + trip.city : ''}</div>
        ${trip.note ? `<div class="note">${trip.note}</div>` : ''}
        ${photoHtml ? `<div class="photos">${photoHtml}</div>` : ''}
        <div class="actions">
          <button class="popup-btn popup-btn-edit" onclick="editTrip('${trip.id}')">${t('edit')}</button>
          <button class="popup-btn popup-btn-del" onclick="deleteTrip('${trip.id}')">${t('delete')}</button>
        </div>
      </div>
    `);

    const marker = L.marker([trip.lat, trip.lng], { icon }).addTo(map).bindPopup(popup);
    markers.push(marker);
  });

  updateFilters();
  renderCountryHighlights();
  localStorage.setItem('travelsnap_trips', JSON.stringify(trips));
}

function updateFilters() {
  const years = [...new Set(trips.filter(t => t.dateStart).map(t => t.dateStart.substring(0, 4)))].sort().reverse();
  const bar = document.getElementById('filter-bar');
  bar.innerHTML = `<button class="filter-chip ${currentFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">${t('filterAll')}</button>`;
  years.forEach(y => {
    bar.innerHTML += `<button class="filter-chip ${currentFilter === y ? 'active' : ''}" onclick="setFilter('${y}')">${y}${t('filterYear')}</button>`;
  });
}

function setFilter(f) { currentFilter = f; render(); }

// ===== PANEL =====
function openAddPanel() {
  document.getElementById('panel-overlay').classList.add('active');
  document.getElementById('side-panel').classList.add('active');
  document.getElementById('panel-title-text').textContent = t('panelAdd');
  document.getElementById('edit-id').value = '';
  uploadedPhotos = [];
  document.getElementById('photo-preview').innerHTML = '';
}
function closePanel() {
  document.getElementById('panel-overlay').classList.remove('active');
  document.getElementById('side-panel').classList.remove('active');
  document.getElementById('trip-form').reset();
  uploadedPhotos = [];
  document.getElementById('photo-preview').innerHTML = '';
}

// ===== SAVE =====
async function saveTrip(e) {
  e.preventDefault();
  const editId = document.getElementById('edit-id').value;
  let lat = parseFloat(document.getElementById('inp-lat').value);
  let lng = parseFloat(document.getElementById('inp-lng').value);
  const place = document.getElementById('inp-place').value;
  const country = document.getElementById('inp-country').value;
  const city = document.getElementById('inp-city').value;

  if (isNaN(lat) || isNaN(lng)) {
    const coords = await geocode(`${place}, ${city || ''} ${country}`.trim());
    if (coords) { lat = coords.lat; lng = coords.lng; }
    else { alert(t('geoFail')); return; }
  }

  const trip = {
    id: editId || Date.now().toString(), place, country, city,
    dateStart: document.getElementById('inp-date-start').value,
    dateEnd: document.getElementById('inp-date-end').value,
    note: document.getElementById('inp-note').value,
    photos: uploadedPhotos.slice(0, 2), lat, lng,
    emoji: getEmoji(country)
  };

  if (editId) { const idx = trips.findIndex(t => t.id === editId); if (idx >= 0) trips[idx] = trip; }
  else trips.push(trip);

  closePanel(); render();
  map.flyTo([lat, lng], 6, { duration: 1.5 });
}

// ===== EDIT / DELETE =====
function editTrip(id) {
  const trip = trips.find(t => t.id === id);
  if (!trip) return;
  map.closePopup(); openAddPanel();
  document.getElementById('panel-title-text').textContent = t('panelEdit');
  document.getElementById('edit-id').value = id;
  document.getElementById('inp-place').value = trip.place;
  document.getElementById('inp-country').value = trip.country;
  document.getElementById('inp-city').value = trip.city || '';
  document.getElementById('inp-date-start').value = trip.dateStart;
  document.getElementById('inp-date-end').value = trip.dateEnd || '';
  document.getElementById('inp-note').value = trip.note || '';
  document.getElementById('inp-lat').value = trip.lat;
  document.getElementById('inp-lng').value = trip.lng;
  uploadedPhotos = trip.photos || [];
  renderPhotoPreview();
}
function deleteTrip(id) {
  if (!confirm(t('confirmDel'))) return;
  trips = trips.filter(t => t.id !== id);
  map.closePopup(); render();
}

// ===== PHOTOS =====
function handlePhotos(input) {
  Array.from(input.files).slice(0, 2 - uploadedPhotos.length).forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => { if (uploadedPhotos.length < 2) { uploadedPhotos.push(e.target.result); renderPhotoPreview(); } };
    reader.readAsDataURL(file);
  });
  input.value = '';
}
function renderPhotoPreview() {
  document.getElementById('photo-preview').innerHTML = uploadedPhotos.map((p, i) =>
    `<div class="photo-preview-item"><img src="${p}"><button class="remove" onclick="removePhoto(${i})">âœ•</button></div>`
  ).join('');
}
function removePhoto(i) { uploadedPhotos.splice(i, 1); renderPhotoPreview(); }

// ===== LIST =====
function openList() {
  document.getElementById('list-overlay').classList.add('active');
  document.getElementById('list-panel').classList.add('active');
  const sorted = [...trips].sort((a, b) => (b.dateStart || '').localeCompare(a.dateStart || ''));
  const el = document.getElementById('trip-list');
  if (!sorted.length) { el.innerHTML = `<div style="text-align:center;color:var(--text-dim);padding:40px">${t('noTrips')}</div>`; return; }
  el.innerHTML = sorted.map(t => `
    <div class="list-item" onclick="flyToTrip('${t.id}')">
      <div class="list-item-icon">${t.emoji || 'ğŸ“'}</div>
      <div class="list-item-info">
        <div class="list-item-name">${t.place}</div>
        <div class="list-item-date">${t.dateStart || '?'} Â· ${t.country}${t.city ? ' Â· '+t.city : ''}</div>
      </div>
    </div>
  `).join('');
}
function closeList() {
  document.getElementById('list-overlay').classList.remove('active');
  document.getElementById('list-panel').classList.remove('active');
}
function flyToTrip(id) {
  const trip = trips.find(t => t.id === id); if (!trip) return;
  closeList(); map.flyTo([trip.lat, trip.lng], 8, { duration: 1 });
  setTimeout(() => {
    const m = markers.find(mk => { const ll = mk.getLatLng(); return Math.abs(ll.lat-trip.lat)<0.001 && Math.abs(ll.lng-trip.lng)<0.001; });
    if (m) m.openPopup();
  }, 1200);
}

// ===== LIGHTBOX =====
function showLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').classList.add('active'); }
function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }

// ===== EXPORT =====
let exportDataUrl = null;
async function exportImage() {
  if (!trips.length) { alert(t('noData')); return; }
  document.getElementById('export-overlay').classList.add('active');
  document.getElementById('export-preview').innerHTML = `<p style="color:var(--text-dim)">ğŸ¨ ${t('exportGen')}</p>`;

  const countries = [...new Set(trips.map(t => t.country))];
  const cities = [...new Set(trips.filter(t => t.city).map(t => t.city))];

  // Create offscreen export map
  const wrapper = document.createElement('div');
  wrapper.style.cssText = 'position:fixed;left:-9999px;top:0;width:1080px;height:1440px;';
  wrapper.innerHTML = `
    <div id="export-root" style="width:1080px;height:1440px;background:#f0f9ff;font-family:-apple-system,PingFang SC,sans-serif;overflow:hidden;">
      <div style="text-align:center;padding:30px 40px 16px;">
        <div style="font-size:36px;font-weight:800;color:#1e293b;">${t('exportMyTrips')}</div>
        <div style="font-size:15px;color:#64748b;margin-top:6px;">${countries.length} ${t('countries')} Â· ${cities.length} ${t('cities')} Â· ${trips.length} ${t('trips')}</div>
      </div>
      <div id="export-map-container" style="width:1000px;height:900px;margin:0 auto;border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.1);"></div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:20px 40px 0;">
        ${countries.map(c => `<div style="background:${getCountryColor(c)}22;color:${getCountryColor(c)};padding:6px 14px;border-radius:16px;font-size:13px;border:1px solid ${getCountryColor(c)}44;">${getEmoji(c)} ${c}</div>`).join('')}
      </div>
      <div style="text-align:center;color:#94a3b8;font-size:12px;padding:16px;">TravelSnap Â· ${new Date().getFullYear()}</div>
    </div>
  `;
  document.body.appendChild(wrapper);

  // Create export map
  const exportMap = L.map('export-map-container', { zoomControl: false, attributionControl: false });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(exportMap);

  // Fit bounds to all trips
  const bounds = L.latLngBounds(trips.map(t => [t.lat, t.lng]));
  exportMap.fitBounds(bounds.pad(0.3));

  // Add country highlights
  if (geoJsonData) {
    const nameMap = {
      'ä¸­å›½':'China','ç¾å›½':'United States of America','æ—¥æœ¬':'Japan','éŸ©å›½':'South Korea',
      'æ³•å›½':'France','å¾·å›½':'Germany','è‹±å›½':'United Kingdom','æ„å¤§åˆ©':'Italy','è¥¿ç­ç‰™':'Spain',
      'æ¾³å¤§åˆ©äºš':'Australia','åŠ æ‹¿å¤§':'Canada','æ–°åŠ å¡':'Singapore','æ³°å›½':'Thailand',
      'è¶Šå—':'Vietnam','å°åº¦':'India','å·´è¥¿':'Brazil','å¢¨è¥¿å“¥':'Mexico','åŸƒåŠ':'Egypt',
      'åœŸè€³å…¶':'Turkey','å¸Œè…Š':'Greece','ç‘å£«':'Switzerland','è·å…°':'Netherlands',
      'è‘¡è„ç‰™':'Portugal','ä¿„ç½—æ–¯':'Russia','é©¬æ¥è¥¿äºš':'Malaysia','å°å°¼':'Indonesia',
      'æ–°è¥¿å…°':'New Zealand','å¥¥åœ°åˆ©':'Austria','ç‘å…¸':'Sweden','æŒªå¨':'Norway',
      'ä¸¹éº¦':'Denmark','èŠ¬å…°':'Finland','å†°å²›':'Iceland','æ·å…‹':'Czech Republic',
      'æ³¢å…°':'Poland','åŒˆç‰™åˆ©':'Hungary','æŸ¬åŸ”å¯¨':'Cambodia','ç¼…ç”¸':'Myanmar',
      'è²å¾‹å®¾':'Philippines','å—é':'South Africa','é˜¿è”é…‹':'United Arab Emirates',
      'ä»¥è‰²åˆ—':'Israel','å°æ¹¾':'Taiwan','çˆ±å°”å…°':'Ireland',
    };
    const visitedCountries = [...new Set(trips.map(t => t.country))];
    visitedCountries.forEach(vc => {
      const enName = nameMap[vc] || vc;
      const color = getCountryColor(vc);
      geoJsonData.features.filter(f => {
        const name = f.properties.ADMIN || f.properties.name || '';
        return name.toLowerCase() === enName.toLowerCase() || name.includes(enName) || enName.includes(name);
      }).forEach(feat => {
        L.geoJSON(feat, { style: { fillColor: color, fillOpacity: 0.35, color: color, weight: 2, opacity: 0.7 } }).addTo(exportMap);
      });
    });
  }

  // Add markers with labels
  trips.forEach(trip => {
    const icon = L.divIcon({
      className: '',
      html: `<div style="background:white;border:3px solid ${getCountryColor(trip.country)};border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.3)">${trip.emoji||'ğŸ“'}</div>`,
      iconSize: [28, 28], iconAnchor: [14, 14]
    });
    const marker = L.marker([trip.lat, trip.lng], { icon }).addTo(exportMap);
    // City label
    marker.bindTooltip(trip.place, {
      permanent: true, direction: 'right', offset: [14, 0],
      className: 'export-label'
    });
  });

  // Inject label style
  const style = document.createElement('style');
  style.textContent = '.export-label { background:rgba(255,255,255,0.9);border:1px solid #cbd5e1;border-radius:6px;padding:2px 8px;font-size:12px;font-weight:600;color:#1e293b;box-shadow:0 1px 4px rgba(0,0,0,0.1); }';
  document.head.appendChild(style);

  // Wait for tiles to load then capture
  await new Promise(resolve => setTimeout(resolve, 3000));

  try {
    const canvas = await html2canvas(document.getElementById('export-root'), {
      useCORS: true, allowTaint: true, scale: 2, backgroundColor: '#f0f9ff',
      width: 1080, height: 1440
    });
    exportDataUrl = canvas.toDataURL('image/png');
    document.getElementById('export-preview').innerHTML = `<img src="${exportDataUrl}" style="width:100%;border-radius:8px">`;
  } catch(e) {
    document.getElementById('export-preview').innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
  }

  exportMap.remove();
  document.body.removeChild(wrapper);
  document.head.removeChild(style);
}
function downloadExport() {
  if (!exportDataUrl) return;
  const a = document.createElement('a'); a.href = exportDataUrl;
  a.download = `TravelSnap_${new Date().toISOString().slice(0,10)}.png`; a.click();
}
function closeExport() { document.getElementById('export-overlay').classList.remove('active'); }

// ===== EMOJI =====
function getEmoji(country) {
  const m = {
    'ä¸­å›½':'ğŸ‡¨ğŸ‡³','ç¾å›½':'ğŸ‡ºğŸ‡¸','æ—¥æœ¬':'ğŸ‡¯ğŸ‡µ','éŸ©å›½':'ğŸ‡°ğŸ‡·','æ³•å›½':'ğŸ‡«ğŸ‡·','å¾·å›½':'ğŸ‡©ğŸ‡ª',
    'è‹±å›½':'ğŸ‡¬ğŸ‡§','æ„å¤§åˆ©':'ğŸ‡®ğŸ‡¹','è¥¿ç­ç‰™':'ğŸ‡ªğŸ‡¸','æ¾³å¤§åˆ©äºš':'ğŸ‡¦ğŸ‡º','åŠ æ‹¿å¤§':'ğŸ‡¨ğŸ‡¦',
    'æ–°åŠ å¡':'ğŸ‡¸ğŸ‡¬','æ³°å›½':'ğŸ‡¹ğŸ‡­','è¶Šå—':'ğŸ‡»ğŸ‡³','å°åº¦':'ğŸ‡®ğŸ‡³','å·´è¥¿':'ğŸ‡§ğŸ‡·',
    'å¢¨è¥¿å“¥':'ğŸ‡²ğŸ‡½','åŸƒåŠ':'ğŸ‡ªğŸ‡¬','åœŸè€³å…¶':'ğŸ‡¹ğŸ‡·','å¸Œè…Š':'ğŸ‡¬ğŸ‡·','ç‘å£«':'ğŸ‡¨ğŸ‡­',
    'China':'ğŸ‡¨ğŸ‡³','USA':'ğŸ‡ºğŸ‡¸','Japan':'ğŸ‡¯ğŸ‡µ','Korea':'ğŸ‡°ğŸ‡·','France':'ğŸ‡«ğŸ‡·',
    'Germany':'ğŸ‡©ğŸ‡ª','UK':'ğŸ‡¬ğŸ‡§','Italy':'ğŸ‡®ğŸ‡¹','Spain':'ğŸ‡ªğŸ‡¸','Singapore':'ğŸ‡¸ğŸ‡¬',
    'Thailand':'ğŸ‡¹ğŸ‡­','India':'ğŸ‡®ğŸ‡³','Brazil':'ğŸ‡§ğŸ‡·','Canada':'ğŸ‡¨ğŸ‡¦','Australia':'ğŸ‡¦ğŸ‡º',
    'è·å…°':'ğŸ‡³ğŸ‡±','è‘¡è„ç‰™':'ğŸ‡µğŸ‡¹','ä¿„ç½—æ–¯':'ğŸ‡·ğŸ‡º','é©¬æ¥è¥¿äºš':'ğŸ‡²ğŸ‡¾','å°å°¼':'ğŸ‡®ğŸ‡©',
    'æ–°è¥¿å…°':'ğŸ‡³ğŸ‡¿','å¥¥åœ°åˆ©':'ğŸ‡¦ğŸ‡¹','ç‘å…¸':'ğŸ‡¸ğŸ‡ª','æŒªå¨':'ğŸ‡³ğŸ‡´','ä¸¹éº¦':'ğŸ‡©ğŸ‡°',
    'èŠ¬å…°':'ğŸ‡«ğŸ‡®','å†°å²›':'ğŸ‡®ğŸ‡¸','æ·å…‹':'ğŸ‡¨ğŸ‡¿','æ³¢å…°':'ğŸ‡µğŸ‡±','åŒˆç‰™åˆ©':'ğŸ‡­ğŸ‡º',
    'æŸ¬åŸ”å¯¨':'ğŸ‡°ğŸ‡­','ç¼…ç”¸':'ğŸ‡²ğŸ‡²','è²å¾‹å®¾':'ğŸ‡µğŸ‡­','å—é':'ğŸ‡¿ğŸ‡¦','é˜¿è”é…‹':'ğŸ‡¦ğŸ‡ª',
    'ä»¥è‰²åˆ—':'ğŸ‡®ğŸ‡±','å°æ¹¾':'ğŸ‡¹ğŸ‡¼','çˆ±å°”å…°':'ğŸ‡®ğŸ‡ª',
  };
  return m[country] || 'ğŸ“';
}

// ===== INIT =====
async function init() {
  await loadGeoJson();
  if (trips.length === 0) {
    trips = [
      { id:'1', place:'æ³¢ç‰¹å…°', country:'ç¾å›½', city:'Portland', dateStart:'2025-01-01', note:'å®¶ ğŸ ', photos:[], lat:45.5155, lng:-122.6789, emoji:'ğŸ‡ºğŸ‡¸' },
      { id:'2', place:'å—äº¬', country:'ä¸­å›½', city:'å—äº¬', dateStart:'2025-06-15', dateEnd:'2025-06-30', note:'å›è€å®¶æ¢äº²', photos:[], lat:32.0603, lng:118.7969, emoji:'ğŸ‡¨ğŸ‡³' },
    ];
  }
  applyLang();
  render();
}
init();
</script>
</body>
</html>
